name: Auto-merge Version Bumps

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  automerge:
    name: Auto-merge Minor Version Bumps
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_run' &&
      github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Get PR from workflow run
        id: get-pr
        uses: actions/github-script@v8
        with:
          script: |
            const headBranch = context.payload.workflow_run.head_branch;
            console.log(`Workflow run branch: ${headBranch}`);

            // Find PRs associated with this workflow run
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${headBranch}`
            });

            if (prs.length === 0) {
              console.log('No open PR found for this branch');
              return null;
            }

            const pr = prs[0];
            console.log(`Found PR #${pr.number}: ${pr.title}`);

            const labels = pr.labels.map(l => l.name);
            console.log(`Labels: ${labels.join(', ')}`);

            const isVersionBumpAuto = labels.includes('version-bump-auto');
            const isMinorBump = labels.includes('minor-version-bump');
            const isMajorBump = labels.includes('major-version-bump');

            return {
              number: pr.number,
              isVersionBumpAuto,
              isMinorBump,
              isMajorBump,
              shouldAutoMerge: isVersionBumpAuto && isMinorBump && !isMajorBump
            };

      - name: Auto-merge minor version bump
        if: steps.get-pr.outputs.result != 'null' && fromJSON(steps.get-pr.outputs.result).shouldAutoMerge
        uses: actions/github-script@v8
        with:
          script: |
            const prData = ${{ steps.get-pr.outputs.result }};
            const prNumber = prData.number;

            // Helper function to wait
            const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

            // Poll for PR to become mergeable with retries
            // This handles the case where other checks (CodeQL, Integration Tests, etc.)
            // are still running when CI completes
            const maxAttempts = 10;
            const initialDelayMs = 30000; // 30 seconds
            const maxDelayMs = 120000; // 2 minutes

            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });

              console.log(`Attempt ${attempt}/${maxAttempts}: PR #${prNumber} mergeable_state = ${pr.mergeable_state}`);

              // Check if PR is ready to merge
              if (pr.mergeable_state === 'clean') {
                console.log(`PR #${prNumber} is ready - merging directly`);
                await github.rest.pulls.merge({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                  merge_method: 'squash'
                });
                console.log(`Successfully merged PR #${prNumber}`);
                return;
              }

              // If PR is blocked or has conflicts, don't retry
              if (pr.mergeable_state === 'blocked' || pr.mergeable_state === 'dirty') {
                console.log(`PR #${prNumber} is ${pr.mergeable_state} - cannot auto-merge`);
                return;
              }

              // If PR was already merged or closed, exit
              if (pr.state !== 'open') {
                console.log(`PR #${prNumber} is no longer open (state: ${pr.state})`);
                return;
              }

              // If this is the last attempt, try enabling auto-merge as fallback
              if (attempt === maxAttempts) {
                console.log(`Max attempts reached. Enabling auto-merge as fallback...`);
                try {
                  await github.graphql(`
                    mutation($pullRequestId: ID!) {
                      enablePullRequestAutoMerge(input: {
                        pullRequestId: $pullRequestId,
                        mergeMethod: SQUASH
                      }) {
                        pullRequest {
                          autoMergeRequest {
                            enabledAt
                          }
                        }
                      }
                    }
                  `, {
                    pullRequestId: pr.node_id
                  });
                  console.log(`Auto-merge enabled for PR #${prNumber}`);
                } catch (error) {
                  console.log(`Failed to enable auto-merge: ${error.message}`);
                  throw error;
                }
                return;
              }

              // Wait before next attempt with exponential backoff (capped)
              const delayMs = Math.min(initialDelayMs * Math.pow(1.5, attempt - 1), maxDelayMs);
              console.log(`PR not ready yet, waiting ${delayMs / 1000}s before retry...`);
              await sleep(delayMs);
            }

      - name: Comment on major version bump
        if: steps.get-pr.outputs.result != 'null' && fromJSON(steps.get-pr.outputs.result).isMajorBump
        uses: actions/github-script@v8
        with:
          script: |
            const prData = ${{ steps.get-pr.outputs.result }};
            const prNumber = prData.number;

            // Check if we already commented
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('Major version bump detected')
            );

            if (!botComment) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `## ‚ö†Ô∏è Major version bump detected

            This PR contains a **major version update** which may include breaking changes.

            **CI Status**: ‚úÖ Passed

            **Action Required**: Please review the changelog and test manually before merging.

            - [ ] Reviewed upstream changelog for breaking changes
            - [ ] Verified integration tests cover the changes
            - [ ] Ready to merge

            ü§ñ *This comment was auto-generated by the version bump workflow*`
              });
            }
