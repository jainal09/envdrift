name: Auto-merge Version Bumps

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  automerge:
    name: Auto-merge Minor Version Bumps
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_run' &&
      github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Get PR from workflow run
        id: get-pr
        uses: actions/github-script@v7
        with:
          script: |
            const headBranch = context.payload.workflow_run.head_branch;
            console.log(`Workflow run branch: ${headBranch}`);

            // Find PRs associated with this workflow run
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${headBranch}`
            });

            if (prs.length === 0) {
              console.log('No open PR found for this branch');
              return null;
            }

            const pr = prs[0];
            console.log(`Found PR #${pr.number}: ${pr.title}`);

            const labels = pr.labels.map(l => l.name);
            console.log(`Labels: ${labels.join(', ')}`);

            const isVersionBumpAuto = labels.includes('version-bump-auto');
            const isMinorBump = labels.includes('minor-version-bump');
            const isMajorBump = labels.includes('major-version-bump');

            return {
              number: pr.number,
              isVersionBumpAuto,
              isMinorBump,
              isMajorBump,
              shouldAutoMerge: isVersionBumpAuto && isMinorBump && !isMajorBump
            };

      - name: Auto-merge minor version bump
        if: steps.get-pr.outputs.result != 'null' && fromJSON(steps.get-pr.outputs.result).shouldAutoMerge
        uses: actions/github-script@v7
        with:
          script: |
            const prData = ${{ steps.get-pr.outputs.result }};
            const prNumber = prData.number;

            // Get the PR details
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            // Check if PR is already mergeable (all checks passed)
            if (pr.mergeable_state === 'clean') {
              console.log(`PR #${prNumber} is ready - merging directly`);
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'squash'
              });
              console.log(`Successfully merged PR #${prNumber}`);
              return;
            }

            // Otherwise, enable auto-merge to queue it
            console.log(`PR #${prNumber} has pending checks - enabling auto-merge`);
            try {
              await github.graphql(`
                mutation($pullRequestId: ID!) {
                  enablePullRequestAutoMerge(input: {
                    pullRequestId: $pullRequestId,
                    mergeMethod: SQUASH
                  }) {
                    pullRequest {
                      autoMergeRequest {
                        enabledAt
                      }
                    }
                  }
                }
              `, {
                pullRequestId: pr.node_id
              });
              console.log(`Auto-merge enabled for PR #${prNumber}`);
            } catch (error) {
              // If auto-merge fails due to clean status, try direct merge
              if (error.message.includes('clean status')) {
                console.log(`Auto-merge not needed, merging directly`);
                await github.rest.pulls.merge({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                  merge_method: 'squash'
                });
                console.log(`Successfully merged PR #${prNumber}`);
              } else {
                throw error;
              }
            }

      - name: Comment on major version bump
        if: steps.get-pr.outputs.result != 'null' && fromJSON(steps.get-pr.outputs.result).isMajorBump
        uses: actions/github-script@v7
        with:
          script: |
            const prData = ${{ steps.get-pr.outputs.result }};
            const prNumber = prData.number;

            // Check if we already commented
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('Major version bump detected')
            );

            if (!botComment) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `## ‚ö†Ô∏è Major version bump detected

            This PR contains a **major version update** which may include breaking changes.

            **CI Status**: ‚úÖ Passed

            **Action Required**: Please review the changelog and test manually before merging.

            - [ ] Reviewed upstream changelog for breaking changes
            - [ ] Verified integration tests cover the changes
            - [ ] Ready to merge

            ü§ñ *This comment was auto-generated by the version bump workflow*`
              });
            }
